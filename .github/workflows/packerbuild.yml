name: Build Google Image

on:
  push:
    branches:
      - main

jobs:
  packerbuild-googleimage:
    name: Build Google Machine Image
    runs-on: ubuntu-latest

    steps:
    - name: Starting the Postgres Service
      run: |
        sudo service postgresql start
        sudo chmod 700 /var/run/postgresql/.s.PGSQL.5432 || true
        sudo sed -i 's/^\(host.all.*all.\)\(ident\)\(.*\)$/\1md5\3/g' /etc/postgresql/14/main/pg_hba.conf
        sudo systemctl restart postgresql
        sudo systemctl status postgresql
        sudo -i -u postgres psql -c "ALTER USER postgres WITH PASSWORD '${{ secrets.PGPASSWORD }}';"

    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
          node-version: 20.6
          cache: 'npm'

    - name: Create Zip Archive
      run: |
        zip -r webapp.zip ./

    - name: Install dependencies
      run: npm install

    - name: Display .env file
      run: |
        echo APP_PORT=${{ vars.APP_ENV }} >> .env
        echo DB_NAME=${{ secrets.PGDATABASE }} >> .env
        echo DB_USER=${{ secrets.PGUSER }} >> .env
        echo DB_PASSWORD=${{ secrets.PGPASSWORD }} >> .env
        echo DB_PORT=${{ secrets.PGPORT }} >> .env
        echo DB_HOSTNAME=${{ secrets.PGHOST }} >> .env
        echo DB_DIALECT=postgres >> .env
        echo TOPIC_NAME=${{ secrets.TOPIC_NAME }} >> .env
        echo SENDER_EMAIL=${{ secrets.SENDER_EMAIL }} >> .env
        cat .env

    - name: Run Integration tests
      run : npm test
    
    - name: Authenticate with Google Cloud Platform
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.PACKER_SERVICEACCOUNT_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Set up Packer
      run: |
        wget https://releases.hashicorp.com/packer/1.7.3/packer_1.7.3_linux_amd64.zip
        unzip packer_1.7.3_linux_amd64.zip
        chmod +x packer
        sudo mv packer /usr/local/bin/
      shell: bash
    
    - name: Initialize Packer
      run: packer init gcp.pkr.hcl

    - name: Build Machine Image
      run: |
        packer build \
          -var "project_id=${{ secrets.PROJECTID }}" \
          -var "zone=${{ secrets.ZONE }}" \
          -var "source_image_family=${{ secrets.IMAGEFAMILY }}" \
          gcp.pkr.hcl
    
    - name: Get latest machine image ID
      id: get-image-id
      run: |
        latest_image=$(gcloud compute images list --format="value(name)" --filter="name:packer-*" --sort-by="~creationTimestamp" --limit=1) \
        echo "::set-output name=image_id::$latest_image"
    
    - name: Create Instance Template
      run: |
        gcloud compute instance-templates create cyse-demovm1 \
          --create-disk=image=${latest_image},size=20,type=pd-balanced,auto-delete=yes,boot=yes,kms-key=projects/csye6225-ankit-cloud-413805/locations/us-central1/keyRings/webapp-keyring/cryptoKeys/webapp-vm-key \
          --machine-type=e2-medium \
          --can-ip-forward \
          --tags=webapp-resource \
          --network-interface=network-tier=STANDARD,subnet=https://www.googleapis.com/compute/beta/projects/csye6225-ankit-cloud-413805/regions/us-central1/subnetworks/webapp \
          --service-account=logging-serviceaccount@csye6225-ankit-cloud-413805.iam.gserviceaccount.com \
          --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/pubsub,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/trace.append \
          --instance-template-region=us-central1
      env:
          latest_image: ${{ steps.get-image-id.outputs.image_id }}
    
    - name: Set Instance Template for Managed Instance Group
      run: |
        gcloud compute instance-groups managed set-instance-template appserver-igm \
          --template=projects/csye6225-ankit-cloud-413805/regions/us-central1/instanceTemplates/cyse-demovm1 \
          --region=us-central1

    # - name: Recreate Instances in Managed Instance Group
    #   run: |
    #     gcloud compute instance-groups managed rolling-action replace appserver-igm \
    #       --max-surge=3 \
    #       --max-unavailable=0 \
    #       --region=us-central1
    
    # - name: Wait for Substitution of instances in MIG
    #   run: |
    #     gcloud compute instance-groups managed wait-until --stable appserver-igm \
    #       --region=us-central1
